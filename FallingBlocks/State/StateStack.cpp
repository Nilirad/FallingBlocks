#include "StateStack.h"
#include "StateFactory.h"
#include <SFML/Graphics/RenderWindow.hpp>

/////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////  METHODS  /////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////

StateStack::StateStack()
	: mStack()
	, mPendingList()
{
}

void StateStack::requestPop() {
	mPendingList.push(NONE);
}

void StateStack::requestPush(StateID state) {
	mPendingList.push(state);
}

/////////////////////////////////////////////////////////////////////////////////////////

void StateStack::push(StateID state) {
	ApplicationState* stateInstance = StateFactory::createState(state);
	mStack.push_back(stateInstance);
}

/////////////////////////////////////////////////////////////////////////////////////////

void StateStack::pop() {
	if (!mStack.empty()) {
		ApplicationState* popped = mStack.back();
		mStack.pop_back();
		delete popped;
	}
}

/////////////////////////////////////////////////////////////////////////////////////////

void StateStack::addCommand(StateID command) {
	mPendingList.push(command);
}

/////////////////////////////////////////////////////////////////////////////////////////

void StateStack::processPendingList() {
	while (mPendingList.size() > 0) {
		StateID command = mPendingList.front();
		mPendingList.pop();

		if (command == NONE) {
			pop();
		} else {
			push(command);
			mStack.back()->start();
		}
	}
}

/////////////////////////////////////////////////////////////////////////////////////////

bool StateStack::isEmpty() {
	return mStack.empty();
}

/////////////////////////////////////////////////////////////////////////////////////////

void StateStack::handleInput() {
	if (!mStack.empty()) {
		mStack.back()->handleInput();
	}
}

/////////////////////////////////////////////////////////////////////////////////////////

void StateStack::render(sf::RenderWindow* window) {
	for each (auto item in mStack) {
		item->render(window);
	}
}

/////////////////////////////////////////////////////////////////////////////////////////

void StateStack::update(sf::Time dt) {
	if (!mStack.empty()) {
		mStack.back()->update(dt);
	}
}
